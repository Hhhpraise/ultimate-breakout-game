<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ultimate Breakout Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: white;
            overflow: hidden;
            touch-action: none;
        }

        .game-container {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
            width: 100%;
            max-width: 820px;
            height: 100vh;
            max-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        canvas {
            border: 3px solid #fff;
            border-radius: 10px;
            background: linear-gradient(45deg, #0f0f23, #1a1a2e);
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.5);
            flex: 1;
            max-width: 100%;
            height: auto;
        }

        .ui {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: bold;
        }

        .controls {
            margin-top: 10px;
            font-size: 12px;
            opacity: 0.8;
            line-height: 1.3;
        }

        .mobile-controls {
            display: none;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-top: 10px;
        }

        .control-button {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 15px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            user-select: none;
            transition: all 0.1s;
        }

        .control-button:active {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0.95);
        }

        .control-group {
            display: flex;
            gap: 20px;
        }

        .laser-button {
            background: linear-gradient(45deg, #00d2d3, #0099cc);
            font-size: 20px;
        }

        .pause-button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            font-size: 16px;
        }

        .sound-button {
            background: linear-gradient(45deg, #28a745, #20c997);
            font-size: 20px;
        }

        .sound-button.muted {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }

        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            display: none;
            z-index: 1000;
            width: 80%;
            max-width: 400px;
        }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
            transition: transform 0.2s;
            touch-action: manipulation;
        }

        .btn:hover, .btn:active {
            transform: scale(1.05);
        }

        .wave-indicator {
            font-size: 14px;
            color: #ffd700;
            margin-bottom: 8px;
        }

        .power-up-indicator {
            font-size: 12px;
            color: #00ff88;
            margin-bottom: 5px;
            min-height: 18px;
        }

        .legend {
            margin-top: 8px;
            font-size: 10px;
            text-align: left;
            background: rgba(0, 0, 0, 0.3);
            padding: 6px;
            border-radius: 6px;
            max-height: 120px;
            overflow-y: auto;
        }

        .legend-item {
            margin: 1px 0;
            display: flex;
            align-items: center;
        }

        .legend-color {
            width: 10px;
            height: 10px;
            margin-right: 4px;
            border-radius: 2px;
        }

        .combo-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 20px;
            font-weight: bold;
            color: #ff6b6b;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 100;
        }

        .pause-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 36px;
            color: white;
            z-index: 999;
            cursor: pointer;
            touch-action: manipulation;
            user-select: none;
        }

        .pause-content {
            text-align: center;
            padding: 20px;
        }

        .pause-title {
            font-size: 48px;
            margin-bottom: 20px;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .pause-subtitle {
            font-size: 18px;
            opacity: 0.8;
            margin-bottom: 30px;
        }

        .resume-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 18px;
            transition: transform 0.2s;
            touch-action: manipulation;
        }

        .resume-btn:hover, .resume-btn:active {
            transform: scale(1.05);
        }

        .start-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            text-align: center;
        }

        .start-screen h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .start-screen p {
            margin: 10px 0;
            max-width: 600px;
            line-height: 1.6;
        }

        .best-score {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 30px;
            border-radius: 50px;
            margin: 20px 0;
            font-size: 1.5rem;
            font-weight: bold;
            color: #00ff88;
        }

        .footer {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 30px;
        }

        .footer a {
            color: #00d2d3;
            text-decoration: none;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .footer a:hover {
            color: #ff6b6b;
            transform: translateY(-2px);
        }

        .footer a i {
            font-size: 1.2rem;
        }

        .sound-toggle {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            user-select: none;
            transition: all 0.2s;
            z-index: 200;
        }

        .sound-toggle.muted {
            background: rgba(220, 53, 69, 0.3);
            border-color: rgba(220, 53, 69, 0.5);
        }

        .sound-toggle:active {
            transform: scale(0.95);
        }

        /* Mobile-specific styles */
        @media (max-width: 768px) {
            .game-container {
                padding: 5px;
                border-radius: 0;
                height: 100vh;
            }

            .mobile-controls {
                display: flex;
            }

            .ui {
                font-size: 14px;
            }

            .wave-indicator {
                font-size: 12px;
            }

            .power-up-indicator {
                font-size: 10px;
            }

            .legend {
                font-size: 9px;
                max-height: 80px;
            }

            .combo-indicator {
                font-size: 16px;
                top: 10px;
                right: 10px;
            }

            .pause-overlay {
                font-size: 28px;
            }

            .pause-title {
                font-size: 36px;
            }

            .pause-subtitle {
                font-size: 16px;
            }

            .start-screen h1 {
                font-size: 1.8rem;
            }

            .start-screen p {
                font-size: 0.9rem;
            }

            .best-score {
                font-size: 1.2rem;
                padding: 10px 20px;
            }

            .footer {
                flex-direction: column;
                gap: 15px;
                margin-top: 15px;
            }

            .btn {
                padding: 12px 24px;
                font-size: 18px;
            }

            .sound-toggle {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
        }

        @media (max-height: 600px) {
            .legend {
                max-height: 60px;
            }

            .controls {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <button class="sound-toggle" id="soundToggle">🔊</button>

        <div class="start-screen" id="startScreen">
            <h1>ULTIMATE BREAKOUT</h1>
            <p>Destroy all bricks without losing your balls! Collect power-ups for special abilities.</p>

            <div class="best-score">Best Score: <span id="bestScore">0</span></div>

            <button class="btn" id="startBtn">START GAME</button>

            <div class="footer">
                <a href="https://hhhpraise.github.io/portfolio/" target="_blank">
                    <i>👨‍💻</i> My Portfolio
                </a>
                <a href="mailto:hhhpraise33@gmail.com">
                    <i>✉️</i> Send Suggestions
                </a>
            </div>
        </div>

        <div class="wave-indicator">Wave: <span id="wave">1</span></div>
        <div class="power-up-indicator" id="powerUpStatus"></div>
        <div class="ui">
            <div>Score: <span id="score">0</span></div>
            <div>Lives: <span id="lives">3</span></div>
            <div>Combo: <span id="combo">0</span></div>
        </div>
        <canvas id="gameCanvas"></canvas>

        <div class="controls" id="desktopControls">
            Use ← → arrow keys or A/D to move • SPACE to shoot laser • P to pause
        </div>

        <div class="mobile-controls" id="mobileControls">
            <div class="control-group">
                <button class="control-button" id="leftBtn">←</button>
                <button class="control-button" id="rightBtn">→</button>
            </div>
            <div class="control-group">
                <button class="control-button laser-button" id="laserBtn">⚡</button>
                <button class="control-button pause-button" id="pauseBtn">⏸</button>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #ff6b6b;"></div>
                <span>Normal (10pts)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ffd700;"></div>
                <span>Strong (25pts, 2 hits)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #c0c0c0;"></div>
                <span>Metal (50pts, 3 hits)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ff4757;"></div>
                <span>Explosive (75pts, destroys nearby)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #2f3542;"></div>
                <span>Unbreakable (blocks balls)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #00ff88;"></div>
                <span>🎁 Power-ups: = (Wide) O (Big) + (Life) * (Multi) ⚡ (Laser) 🔥 (Fire)</span>
            </div>
        </div>

        <div class="combo-indicator" id="comboDisplay" style="display: none;"></div>

        <div class="pause-overlay" id="pauseOverlay">
            <div class="pause-content">
                <div class="pause-title">PAUSED</div>
                <div class="pause-subtitle">Tap anywhere or click the button to resume</div>
                <button class="resume-btn" id="resumeBtn">RESUME GAME</button>
            </div>
        </div>

        <div class="game-over" id="gameOver">
            <h2>Game Over!</h2>
            <p>Final Score: <span id="finalScore">0</span></p>
            <p>Wave Reached: <span id="finalWave">1</span></p>
            <p>Max Combo: <span id="maxCombo">0</span></p>
            <p>Best Score: <span id="gameOverBestScore">0</span></p>
            <button class="btn" onclick="restartGame()">Play Again</button>
        </div>
    </div>

    <script>
        // Device detection
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                         ('ontouchstart' in window) ||
                         (navigator.maxTouchPoints > 0);

        // Sound management
        let soundEnabled = localStorage.getItem('breakoutSoundEnabled') !== 'false';
        const soundToggle = document.getElementById('soundToggle');

        function updateSoundToggle() {
            soundToggle.textContent = soundEnabled ? '🔊' : '🔇';
            soundToggle.classList.toggle('muted', !soundEnabled);
        }

        soundToggle.addEventListener('click', (e) => {
            e.preventDefault();
            soundEnabled = !soundEnabled;
            localStorage.setItem('breakoutSoundEnabled', soundEnabled);
            updateSoundToggle();
        });

        updateSoundToggle();

        // Canvas setup with responsive sizing
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() {
            const container = document.querySelector('.game-container');
            const containerRect = container.getBoundingClientRect();

            if (isMobile) {
                canvas.width = Math.min(containerRect.width - 16, 800);
                canvas.height = Math.min(containerRect.height - 200, 500);
            } else {
                canvas.width = 800;
                canvas.height = 600;
            }
        }

        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // UI elements
        const scoreElement = document.getElementById('score');
        const livesElement = document.getElementById('lives');
        const comboElement = document.getElementById('combo');
        const waveElement = document.getElementById('wave');
        const powerUpStatusElement = document.getElementById('powerUpStatus');
        const gameOverDiv = document.getElementById('gameOver');
        const finalScoreElement = document.getElementById('finalScore');
        const finalWaveElement = document.getElementById('finalWave');
        const maxComboElement = document.getElementById('maxCombo');
        const gameOverBestScoreElement = document.getElementById('gameOverBestScore');
        const comboDisplayElement = document.getElementById('comboDisplay');
        const pauseOverlay = document.getElementById('pauseOverlay');
        const resumeBtn = document.getElementById('resumeBtn');
        const startScreen = document.getElementById('startScreen');
        const startBtn = document.getElementById('startBtn');
        const bestScoreElement = document.getElementById('bestScore');

        // Load best score
        let bestScore = localStorage.getItem('breakoutBestScore') || 0;
        bestScoreElement.textContent = bestScore;

        // Show/hide controls based on device
        if (isMobile) {
            document.getElementById('mobileControls').style.display = 'flex';
            document.getElementById('desktopControls').style.display = 'none';
        }

        // Game state
        let gameRunning = false;
        let gamePaused = false;
        let score = 0;
        let lives = 3;
        let wave = 1;
        let combo = 0;
        let maxCombo = 0;
        let lastHitTime = 0;

        // Particles system
        let particles = [];
        let explosions = [];

        // Sound effects using Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(frequency, duration, type = 'sine', volume = 0.1) {
            if (!soundEnabled) return;

            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = type;

                gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                // Silent fail for audio context issues
            }
        }

        // Paddle
        const paddle = {
            x: 0,
            y: 0,
            width: 120,
            height: 15,
            speed: 8,
            originalWidth: 120,
            color: '#fff',
            trail: []
        };

        // Ball
        const ball = {
            x: 0,
            y: 0,
            radius: 8,
            dx: 4,
            dy: -4,
            speed: 4,
            originalRadius: 8,
            trail: [],
            fireBall: false
        };

        // Initialize positions based on canvas size
        function initializePositions() {
            paddle.x = canvas.width / 2 - paddle.width / 2;
            paddle.y = canvas.height - 30;
            ball.x = canvas.width / 2;
            ball.y = canvas.height / 2;
        }

        initializePositions();

        // Lasers
        let lasers = [];
        let canShootLaser = false;
        let laserCooldown = 0;

        // Power-ups
        let powerUps = [];
        let activePowerUps = {
            widePaddle: 0,
            bigBall: 0,
            extraLife: false,
            multiball: [],
            laser: 0,
            fireBall: 0
        };

        const powerUpTypes = [
            { type: 'widePaddle', color: '#ff6b6b', symbol: '=', duration: 15000 },
            { type: 'bigBall', color: '#4ecdc4', symbol: 'O', duration: 12000 },
            { type: 'extraLife', color: '#ffd700', symbol: '+', duration: 0 },
            { type: 'multiball', color: '#ff9ff3', symbol: '*', duration: 0 },
            { type: 'laser', color: '#00d2d3', symbol: '⚡', duration: 20000 },
            { type: 'fireBall', color: '#ff4757', symbol: '🔥', duration: 15000 }
        ];

        // Bricks
        let bricks = [];
        const brickRows = isMobile ? 5 : 6;
        const brickCols = isMobile ? 8 : 10;
        let brickWidth, brickHeight, brickPadding, brickOffsetTop, brickOffsetLeft;

        function calculateBrickDimensions() {
            brickWidth = (canvas.width - 70) / brickCols;
            brickHeight = isMobile ? 18 : 20;
            brickPadding = 5;
            brickOffsetTop = 60;
            brickOffsetLeft = 35;
        }

        calculateBrickDimensions();

        // Brick types
        const brickTypes = {
            normal: { color: '#ff6b6b', hits: 1, points: 10 },
            strong: { color: '#ffd700', hits: 2, points: 25 },
            metal: { color: '#c0c0c0', hits: 3, points: 50 },
            explosive: { color: '#ff4757', hits: 1, points: 75 },
            unbreakable: { color: '#2f3542', hits: -1, points: 0 }
        };

        // Input handling
        const keys = {};
        let touchControls = {
            left: false,
            right: false
        };

        // Desktop controls
        document.addEventListener('keydown', (e) => {
            keys[e.key] = true;
            if (e.key === ' ') {
                e.preventDefault();
                shootLaser();
            }
            if (e.key === 'p' || e.key === 'P') {
                togglePause();
            }
        });
        document.addEventListener('keyup', (e) => keys[e.key] = false);

        // Mobile controls
        if (isMobile) {
            // Touch controls for movement
            let touchStartX = 0;
            let touchCurrentX = 0;
            let isTouching = false;

            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                touchStartX = touch.clientX;
                touchCurrentX = touch.clientX;
                isTouching = true;
            });

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (isTouching) {
                    const touch = e.touches[0];
                    touchCurrentX = touch.clientX;

                    const deltaX = touchCurrentX - touchStartX;
                    const sensitivity = 2;
                    paddle.x += deltaX * sensitivity;

                    // Keep paddle within bounds
                    paddle.x = Math.max(0, Math.min(canvas.width - paddle.width, paddle.x));

                    touchStartX = touchCurrentX;
                }
            });

            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                isTouching = false;
            });

            // Button controls
            const leftBtn = document.getElementById('leftBtn');
            const rightBtn = document.getElementById('rightBtn');
            const laserBtn = document.getElementById('laserBtn');
            const pauseBtn = document.getElementById('pauseBtn');

            // Movement buttons
            leftBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                touchControls.left = true;
            });
            leftBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                touchControls.left = false;
            });

            rightBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                touchControls.right = true;
            });
            rightBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                touchControls.right = false;
            });

            // Laser button
            laserBtn.addEventListener('click', (e) => {
                e.preventDefault();
                shootLaser();
            });

            // Pause button
            pauseBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                togglePause();
            });

            // Prevent context menu on long press
            document.addEventListener('contextmenu', (e) => e.preventDefault());
        }

        function togglePause() {
            if (!gameRunning) return;

            gamePaused = !gamePaused;
            pauseOverlay.style.display = gamePaused ? 'flex' : 'none';

            // Resume audio context if needed
            if (!gamePaused && audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        // Pause overlay click/touch handlers
        pauseOverlay.addEventListener('click', (e) => {
            if (gamePaused) {
                togglePause();
            }
        });

        pauseOverlay.addEventListener('touchend', (e) => {
            e.preventDefault();
            if (gamePaused) {
                togglePause();
            }
        });

        // Resume button
        resumeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (gamePaused) {
                togglePause();
            }
        });

        resumeBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (gamePaused) {
                togglePause();
            }
        });

        function startGame() {
            gameRunning = true;
            startScreen.style.display = 'none';
            restartGame();
        }

        // Start button event listener
        startBtn.addEventListener('click', startGame);

        function createParticles(x, y, color, count = 10) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: x,
                    y: y,
                    dx: (Math.random() - 0.5) * 8,
                    dy: (Math.random() - 0.5) * 8,
                    color: color,
                    life: 1,
                    decay: 0.02 + Math.random() * 0.02,
                    size: 2 + Math.random() * 3
                });
            }
        }

        function createExplosion(x, y) {
            explosions.push({
                x: x,
                y: y,
                radius: 0,
                maxRadius: 60,
                life: 1,
                decay: 0.05
            });

            // Create shockwave particles
            for (let i = 0; i < 20; i++) {
                const angle = (i / 20) * Math.PI * 2;
                particles.push({
                    x: x,
                    y: y,
                    dx: Math.cos(angle) * 6,
                    dy: Math.sin(angle) * 6,
                    color: '#ff4757',
                    life: 1,
                    decay: 0.03,
                    size: 3
                });
            }
        }

        function shootLaser() {
            if (canShootLaser && laserCooldown <= 0 && gameRunning && !gamePaused) {
                lasers.push({
                    x: paddle.x + paddle.width / 2 - 2,
                    y: paddle.y,
                    width: 4,
                    height: 20,
                    dy: -15
                });
                laserCooldown = 15; // Cooldown frames
                playSound(1000, 0.1, 'square', 0.05);
            }
        }

        function createBricks() {
            bricks = [];
            calculateBrickDimensions();

            for (let r = 0; r < brickRows; r++) {
                for (let c = 0; c < brickCols; c++) {
                    let type = 'normal';

                    // Add variety based on wave and position
                    if (wave >= 2 && Math.random() < 0.25) {
                        type = 'strong';
                    }
                    if (wave >= 3 && Math.random() < 0.15) {
                        type = 'metal';
                    }
                    if (wave >= 4 && Math.random() < 0.1) {
                        type = 'explosive';
                    }
                    if (wave >= 5 && Math.random() < 0.05) {
                        type = 'unbreakable';
                    }

                    const brickType = brickTypes[type];
                    bricks.push({
                        x: c * (brickWidth + brickPadding) + brickOffsetLeft,
                        y: r * (brickHeight + brickPadding) + brickOffsetTop,
                        width: brickWidth,
                        height: brickHeight,
                        type: type,
                        color: brickType.color,
                        maxHits: brickType.hits,
                        hits: brickType.hits,
                        points: brickType.points,
                        visible: true
                    });
                }
            }
        }

        function createPowerUp(x, y) {
            if (Math.random() < 0.25) { // 25% chance for power-up
                const powerUpType = powerUpTypes[Math.floor(Math.random() * powerUpTypes.length)];
                powerUps.push({
                    x: x,
                    y: y,
                    width: 20,
                    height: 20,
                    dy: 2,
                    type: powerUpType.type,
                    color: powerUpType.color,
                    symbol: powerUpType.symbol,
                    duration: powerUpType.duration,
                    pulse: 0
                });
            }
        }

        function activatePowerUp(powerUp) {
            playSound(800, 0.2, 'square');
            createParticles(powerUp.x + powerUp.width/2, powerUp.y + powerUp.height/2, powerUp.color, 15);

            switch (powerUp.type) {
                case 'widePaddle':
                    paddle.width = paddle.originalWidth * 1.5;
                    activePowerUps.widePaddle = Date.now() + powerUp.duration;
                    break;

                case 'bigBall':
                    ball.radius = ball.originalRadius * 1.5;
                    activePowerUps.bigBall = Date.now() + powerUp.duration;
                    break;

                case 'extraLife':
                    lives++;
                    livesElement.textContent = lives;
                    break;

                case 'multiball':
                    for (let i = 0; i < 2; i++) {
                        activePowerUps.multiball.push({
                            x: ball.x + (Math.random() - 0.5) * 100,
                            y: ball.y + (Math.random() - 0.5) * 100,
                            radius: ball.radius,
                            dx: (Math.random() - 0.5) * ball.speed * 2,
                            dy: Math.random() > 0.5 ? ball.speed : -ball.speed,
                            trail: []
                        });
                    }
                    break;

                case 'laser':
                    canShootLaser = true;
                    activePowerUps.laser = Date.now() + powerUp.duration;
                    break;

                case 'fireBall':
                    ball.fireBall = true;
                    activePowerUps.fireBall = Date.now() + powerUp.duration;
                    break;
            }
            updatePowerUpDisplay();
        }

        function updateCombo() {
            const now = Date.now();
            if (now - lastHitTime > 2000) {
                combo = 0;
            }
            combo++;
            lastHitTime = now;

            if (combo > maxCombo) {
                maxCombo = combo;
            }

            comboElement.textContent = combo;

            // Show combo display for high combos
            if (combo >= 5) {
                comboDisplayElement.textContent = `${combo}x COMBO!`;
                comboDisplayElement.style.display = 'block';
                comboDisplayElement.style.color = combo >= 10 ? '#ff4757' : '#ffd700';

                setTimeout(() => {
                    comboDisplayElement.style.display = 'none';
                }, 1500);
            }
        }

        function updatePowerUpDisplay() {
            let status = '';
            if (activePowerUps.widePaddle > Date.now()) {
                const remaining = Math.ceil((activePowerUps.widePaddle - Date.now()) / 1000);
                status += `Wide: ${remaining}s `;
            }
            if (activePowerUps.bigBall > Date.now()) {
                const remaining = Math.ceil((activePowerUps.bigBall - Date.now()) / 1000);
                status += `Big: ${remaining}s `;
            }
            if (activePowerUps.laser > Date.now()) {
                const remaining = Math.ceil((activePowerUps.laser - Date.now()) / 1000);
                status += `Laser: ${remaining}s `;
            }
            if (activePowerUps.fireBall > Date.now()) {
                const remaining = Math.ceil((activePowerUps.fireBall - Date.now()) / 1000);
                status += `Fire: ${remaining}s `;
            }
            if (activePowerUps.multiball.length > 0) {
                status += `Multi `;
            }
            powerUpStatusElement.textContent = status;
        }

        function updatePowerUps() {
            // Update power-up positions and effects
            powerUps.forEach((powerUp, index) => {
                powerUp.y += powerUp.dy;
                powerUp.pulse += 0.1;

                // Check collision with paddle
                if (powerUp.y + powerUp.height > paddle.y &&
                    powerUp.x + powerUp.width > paddle.x &&
                    powerUp.x < paddle.x + paddle.width) {
                    activatePowerUp(powerUp);
                    powerUps.splice(index, 1);
                }

                // Remove if off screen
                if (powerUp.y > canvas.height) {
                    powerUps.splice(index, 1);
                }
            });

            // Check power-up expiration
            if (activePowerUps.widePaddle > 0 && activePowerUps.widePaddle < Date.now()) {
                paddle.width = paddle.originalWidth;
                activePowerUps.widePaddle = 0;
            }

            if (activePowerUps.bigBall > 0 && activePowerUps.bigBall < Date.now()) {
                ball.radius = ball.originalRadius;
                activePowerUps.bigBall = 0;
            }

            if (activePowerUps.laser > 0 && activePowerUps.laser < Date.now()) {
                canShootLaser = false;
                activePowerUps.laser = 0;
            }

            if (activePowerUps.fireBall > 0 && activePowerUps.fireBall < Date.now()) {
                ball.fireBall = false;
                activePowerUps.fireBall = 0;
            }

            updatePowerUpDisplay();
        }

        function updateTrails() {
            // Update ball trail
            ball.trail.push({ x: ball.x, y: ball.y });
            if (ball.trail.length > 10) ball.trail.shift();

            // Update multiball trails
            activePowerUps.multiball.forEach(extraBall => {
                extraBall.trail.push({ x: extraBall.x, y: extraBall.y });
                if (extraBall.trail.length > 8) extraBall.trail.shift();
            });

            // Update paddle trail
            paddle.trail.push({ x: paddle.x + paddle.width/2, y: paddle.y });
            if (paddle.trail.length > 5) paddle.trail.shift();
        }

        function updateParticles() {
            particles.forEach((particle, index) => {
                particle.x += particle.dx;
                particle.y += particle.dy;
                particle.life -= particle.decay;
                particle.dy += 0.1; // Gravity

                if (particle.life <= 0) {
                    particles.splice(index, 1);
                }
            });

            explosions.forEach((explosion, index) => {
                explosion.radius += 2;
                explosion.life -= explosion.decay;

                if (explosion.life <= 0 || explosion.radius >= explosion.maxRadius) {
                    explosions.splice(index, 1);
                }
            });
        }

        function updateLasers() {
            if (laserCooldown > 0) laserCooldown--;

            lasers.forEach((laser, laserIndex) => {
                laser.y += laser.dy;

                // Remove lasers that go off screen
                if (laser.y < 0) {
                    lasers.splice(laserIndex, 1);
                    return;
                }

                // Check brick collisions
                bricks.forEach((brick, brickIndex) => {
                    if (brick.visible && brick.type !== 'unbreakable' &&
                        laser.x < brick.x + brick.width &&
                        laser.x + laser.width > brick.x &&
                        laser.y < brick.y + brick.height &&
                        laser.y + laser.height > brick.y) {

                        // Remove laser
                        lasers.splice(laserIndex, 1);

                        // Damage brick
                        hitBrick(brick);
                    }
                });
            });
        }

        function hitBrick(brick) {
            if (brick.type === 'unbreakable') return;

            updateCombo();

            if (brick.type === 'explosive') {
                // Explosive brick destroys nearby bricks
                createExplosion(brick.x + brick.width/2, brick.y + brick.height/2);
                playSound(300, 0.3, 'square', 0.15);

                bricks.forEach(nearbyBrick => {
                    const dx = nearbyBrick.x + nearbyBrick.width/2 - (brick.x + brick.width/2);
                    const dy = nearbyBrick.y + nearbyBrick.height/2 - (brick.y + brick.height/2);
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance < 80 && nearbyBrick.visible && nearbyBrick.type !== 'unbreakable') {
                        nearbyBrick.visible = false;
                        score += nearbyBrick.points + (combo * 5);
                        createParticles(nearbyBrick.x + nearbyBrick.width/2,
                                      nearbyBrick.y + nearbyBrick.height/2,
                                      nearbyBrick.color, 8);
                    }
                });

                brick.visible = false;
                score += brick.points + (combo * 5);
            } else {
                brick.hits--;

                if (brick.hits <= 0) {
                    brick.visible = false;
                    score += brick.points + (combo * 5);
                    createPowerUp(brick.x + brick.width/2, brick.y + brick.height/2);
                    createParticles(brick.x + brick.width/2, brick.y + brick.height/2, brick.color, 12);
                    playSound(600 + (brick.points * 5), 0.15);
                } else {
                    playSound(500, 0.1);
                    createParticles(brick.x + brick.width/2, brick.y + brick.height/2, brick.color, 5);
                }
            }

            scoreElement.textContent = score;
        }

        function drawTrails() {
            // Draw ball trail
            ball.trail.forEach((point, index) => {
                const alpha = index / ball.trail.length;
                ctx.globalAlpha = alpha * 0.5;
                ctx.beginPath();
                ctx.arc(point.x, point.y, ball.radius * alpha, 0, Math.PI * 2);
                ctx.fillStyle = ball.fireBall ? '#ff4757' : '#fff';
                ctx.fill();
            });

            // Draw multiball trails
            activePowerUps.multiball.forEach(extraBall => {
                extraBall.trail.forEach((point, index) => {
                    const alpha = index / extraBall.trail.length;
                    ctx.globalAlpha = alpha * 0.3;
                    ctx.beginPath();
                    ctx.arc(point.x, point.y, extraBall.radius * alpha, 0, Math.PI * 2);
                    ctx.fillStyle = '#ff9ff3';
                    ctx.fill();
                });
            });

            ctx.globalAlpha = 1;
        }

        function drawParticles() {
            particles.forEach(particle => {
                ctx.globalAlpha = particle.life;
                ctx.fillStyle = particle.color;
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                ctx.fill();
            });

            explosions.forEach(explosion => {
                ctx.globalAlpha = explosion.life * 0.3;
                ctx.strokeStyle = '#ff4757';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(explosion.x, explosion.y, explosion.radius, 0, Math.PI * 2);
                ctx.stroke();
            });

            ctx.globalAlpha = 1;
        }

        function drawLasers() {
            ctx.fillStyle = '#00d2d3';
            ctx.shadowColor = '#00d2d3';
            ctx.shadowBlur = 10;

            lasers.forEach(laser => {
                ctx.fillRect(laser.x, laser.y, laser.width, laser.height);
            });

            ctx.shadowBlur = 0;
        }

        function drawPaddle() {
            // Draw paddle trail
            paddle.trail.forEach((point, index) => {
                const alpha = index / paddle.trail.length;
                ctx.globalAlpha = alpha * 0.2;
                ctx.fillStyle = paddle.color;
                ctx.fillRect(point.x - paddle.width/2, point.y, paddle.width, paddle.height);
            });

            ctx.globalAlpha = 1;
            ctx.fillStyle = canShootLaser ? '#00d2d3' : '#fff';
            ctx.shadowColor = canShootLaser ? '#00d2d3' : '#fff';
            ctx.shadowBlur = 10;
            ctx.fillRect(paddle.x, paddle.y, paddle.width, paddle.height);
            ctx.shadowBlur = 0;
        }

        function drawBall() {
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            ctx.fillStyle = ball.fireBall ? '#ff4757' : '#fff';
            ctx.shadowColor = ball.fireBall ? '#ff4757' : '#fff';
            ctx.shadowBlur = ball.fireBall ? 20 : 15;
            ctx.fill();
            ctx.shadowBlur = 0;

            // Create fire particles for fire ball
            if (ball.fireBall) {
                createParticles(ball.x, ball.y, '#ff4757', 2);
            }

            // Draw multiball
            activePowerUps.multiball.forEach(extraBall => {
                ctx.beginPath();
                ctx.arc(extraBall.x, extraBall.y, extraBall.radius, 0, Math.PI * 2);
                ctx.fillStyle = '#ff9ff3';
                ctx.shadowBlur = 10;
                ctx.fill();
                ctx.shadowBlur = 0;
            });
        }

        function drawBricks() {
            bricks.forEach(brick => {
                if (brick.visible) {
                    // Darken brick based on damage
                    const alpha = brick.hits / brick.maxHits;
                    ctx.fillStyle = brick.color;
                    ctx.globalAlpha = brick.type === 'unbreakable' ? 1 : (0.3 + (alpha * 0.7));
                    ctx.shadowColor = brick.color;
                    ctx.shadowBlur = 5;
                    ctx.fillRect(brick.x, brick.y, brick.width, brick.height);
                    ctx.shadowBlur = 0;
                    ctx.globalAlpha = 1;

                    // Add highlight effect
                    if (brick.type !== 'unbreakable') {
                        ctx.fillStyle = `rgba(255, 255, 255, ${alpha * 0.3})`;
                        ctx.fillRect(brick.x, brick.y, brick.width, brick.height / 3);
                    }

                    // Show hit count for multi-hit bricks
                    if (brick.maxHits > 1 && brick.type !== 'unbreakable') {
                        ctx.fillStyle = '#fff';
                        ctx.font = `${isMobile ? '10px' : '12px'} Arial`;
                        ctx.textAlign = 'center';
                        ctx.fillText(brick.hits, brick.x + brick.width/2, brick.y + brick.height/2 + 4);
                    }

                    // Special effects for special bricks
                    if (brick.type === 'explosive') {
                        // Pulsing effect
                        const pulse = Math.sin(Date.now() * 0.01) * 0.5 + 0.5;
                        ctx.globalAlpha = 0.5 + pulse * 0.3;
                        ctx.strokeStyle = '#fff';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(brick.x - 2, brick.y - 2, brick.width + 4, brick.height + 4);
                        ctx.globalAlpha = 1;
                    }

                    if (brick.type === 'unbreakable') {
                        // Diagonal lines pattern
                        ctx.strokeStyle = '#555';
                        ctx.lineWidth = 1;
                        for (let i = 0; i < brick.width; i += 10) {
                            ctx.beginPath();
                            ctx.moveTo(brick.x + i, brick.y);
                            ctx.lineTo(brick.x + i + brick.height, brick.y + brick.height);
                            ctx.stroke();
                        }
                    }
                }
            });
        }

        function drawPowerUps() {
            powerUps.forEach(powerUp => {
                const pulseScale = 1 + Math.sin(powerUp.pulse) * 0.2;
                const size = powerUp.width * pulseScale;

                ctx.fillStyle = powerUp.color;
                ctx.shadowColor = powerUp.color;
                ctx.shadowBlur = 8;
                ctx.fillRect(powerUp.x - (size - powerUp.width) / 2,
                           powerUp.y - (size - powerUp.height) / 2,
                           size, size);
                ctx.shadowBlur = 0;

                // Draw symbol
                ctx.fillStyle = '#fff';
                ctx.font = `bold ${isMobile ? '14px' : '16px'} Arial`;
                ctx.textAlign = 'center';
                ctx.fillText(powerUp.symbol, powerUp.x + powerUp.width/2, powerUp.y + powerUp.height/2 + 6);
            });
        }

        function updatePaddle() {
            // Desktop controls
            if ((keys['ArrowLeft'] || keys['a'] || keys['A']) && paddle.x > 0) {
                paddle.x -= paddle.speed;
            }
            if ((keys['ArrowRight'] || keys['d'] || keys['D']) && paddle.x < canvas.width - paddle.width) {
                paddle.x += paddle.speed;
            }

            // Mobile touch controls
            if (touchControls.left && paddle.x > 0) {
                paddle.x -= paddle.speed;
            }
            if (touchControls.right && paddle.x < canvas.width - paddle.width) {
                paddle.x += paddle.speed;
            }

            // Keep paddle within bounds
            paddle.x = Math.max(0, Math.min(canvas.width - paddle.width, paddle.x));
        }

        function handleBallCollision(ballObj) {
            ballObj.x += ballObj.dx;
            ballObj.y += ballObj.dy;

            // Wall collisions
            if (ballObj.x + ballObj.radius > canvas.width || ballObj.x - ballObj.radius < 0) {
                ballObj.dx = -ballObj.dx;
                playSound(400, 0.1);
                createParticles(ballObj.x, ballObj.y, '#fff', 5);
            }
            if (ballObj.y - ballObj.radius < 0) {
                ballObj.dy = -ballObj.dy;
                playSound(400, 0.1);
                createParticles(ballObj.x, ballObj.y, '#fff', 5);
            }

            // Bottom wall
            if (ballObj.y + ballObj.radius > canvas.height) {
                return false; // Ball is lost
            }

            // Paddle collision
            if (ballObj.y + ballObj.radius > paddle.y &&
                ballObj.x > paddle.x && ballObj.x < paddle.x + paddle.width &&
                ballObj.dy > 0) {

                let hitPos = (ballObj.x - paddle.x) / paddle.width;
                ballObj.dx = (hitPos - 0.5) * ballObj.speed * 2;
                ballObj.dy = -Math.abs(ballObj.dy);
                playSound(300, 0.1);
                createParticles(ballObj.x, paddle.y, '#fff', 8);
            }

            // Brick collisions
            bricks.forEach(brick => {
                if (brick.visible &&
                    ballObj.x + ballObj.radius > brick.x &&
                    ballObj.x - ballObj.radius < brick.x + brick.width &&
                    ballObj.y + ballObj.radius > brick.y &&
                    ballObj.y - ballObj.radius < brick.y + brick.height) {

                    if (brick.type === 'unbreakable') {
                        // Bounce off unbreakable bricks
                        ballObj.dy = -ballObj.dy;
                        playSound(200, 0.1);
                        createParticles(ballObj.x, ballObj.y, '#888', 5);
                    } else {
                        // Fire ball destroys bricks instantly
                        if (ballObj.fireBall || ball.fireBall) {
                            brick.hits = 1; // Force destruction
                        }

                        ballObj.dy = -ballObj.dy;
                        hitBrick(brick);
                    }
                }
            });

            return true; // Ball is still in play
        }

        function updateBall() {
            // Handle main ball
            if (!handleBallCollision(ball)) {
                lives--;
                livesElement.textContent = lives;
                playSound(200, 0.5);
                createParticles(ball.x, canvas.height, '#ff0000', 20);

                if (lives <= 0) {
                    gameOver();
                } else {
                    resetBall();
                }
            }

            // Handle multiball
            activePowerUps.multiball = activePowerUps.multiball.filter(extraBall => {
                return handleBallCollision(extraBall);
            });

            // Check if all destructible bricks are destroyed
            const destructibleBricks = bricks.filter(brick =>
                brick.visible && brick.type !== 'unbreakable'
            );

            if (destructibleBricks.length === 0) {
                nextWave();
            }
        }

        function resetBall() {
            ball.x = canvas.width / 2;
            ball.y = canvas.height / 2;
            ball.dx = (Math.random() > 0.5 ? 1 : -1) * ball.speed;
            ball.dy = -ball.speed;
            ball.trail = [];

            // Reset combo on ball loss
            combo = 0;
            comboElement.textContent = combo;

            // Clear multiball
            activePowerUps.multiball = [];
        }

        function nextWave() {
            wave++;
            waveElement.textContent = wave;
            playSound(800, 0.3, 'sawtooth');
            createParticles(canvas.width/2, canvas.height/2, '#ffd700', 30);

            // Increase difficulty
            ball.speed += 0.5;
            ball.dx = ball.dx > 0 ? ball.speed : -ball.speed;
            ball.dy = ball.dy > 0 ? ball.speed : -ball.speed;
            paddle.speed += 0.5;

            // Add bonus points
            score += wave * 100 + (combo * 50);
            scoreElement.textContent = score;

            createBricks();
            resetBall();

            // Clear power-ups and lasers
            powerUps = [];
            lasers = [];
        }

        function gameOver() {
            gameRunning = false;
            finalScoreElement.textContent = score;
            finalWaveElement.textContent = wave;
            maxComboElement.textContent = maxCombo;
            gameOverBestScoreElement.textContent = bestScore;
            gameOverDiv.style.display = 'block';
            playSound(150, 1, 'square');

            // Update best score
            if (score > bestScore) {
                bestScore = score;
                localStorage.setItem('breakoutBestScore', bestScore);
                gameOverBestScoreElement.textContent = bestScore + " (New Record!)";
            }

            // Final explosion effect
            for (let i = 0; i < 50; i++) {
                createParticles(canvas.width/2 + (Math.random() - 0.5) * 200,
                              canvas.height/2 + (Math.random() - 0.5) * 200,
                              '#ff0000', 1);
            }
        }

        function restartGame() {
            gameRunning = true;
            gamePaused = false;
            score = 0;
            lives = 3;
            wave = 1;
            combo = 0;
            maxCombo = 0;
            ball.speed = 4;
            ball.radius = ball.originalRadius;
            ball.fireBall = false;
            paddle.speed = 8;
            paddle.width = paddle.originalWidth;
            canShootLaser = false;
            laserCooldown = 0;

            scoreElement.textContent = score;
            livesElement.textContent = lives;
            waveElement.textContent = wave;
            comboElement.textContent = combo;
            powerUpStatusElement.textContent = '';
            gameOverDiv.style.display = 'none';
            pauseOverlay.style.display = 'none';
            comboDisplayElement.style.display = 'none';

            // Reset power-ups
            powerUps = [];
            lasers = [];
            particles = [];
            explosions = [];
            activePowerUps = {
                widePaddle: 0,
                bigBall: 0,
                extraLife: false,
                multiball: [],
                laser: 0,
                fireBall: 0
            };

            // Reset touch controls
            touchControls = {
                left: false,
                right: false
            };

            createBricks();
            resetBall();
            initializePositions();

            paddle.trail = [];
        }

        function draw() {
            // Clear canvas with animated background
            const time = Date.now() * 0.002;
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, `hsl(${240 + Math.sin(time) * 10}, 50%, ${10 + Math.sin(time * 0.5) * 5}%)`);
            gradient.addColorStop(1, `hsl(${260 + Math.cos(time) * 10}, 40%, ${15 + Math.cos(time * 0.7) * 5}%)`);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw all game elements
            drawTrails();
            drawParticles();
            drawBricks();
            drawPowerUps();
            drawLasers();
            drawPaddle();
            drawBall();
        }

        function gameLoop() {
            if (gameRunning && !gamePaused) {
                updatePaddle();
                updateBall();
                updatePowerUps();
                updateLasers();
                updateTrails();
                updateParticles();
            }
            draw();
            requestAnimationFrame(gameLoop);
        }

        // Handle orientation change for mobile
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                resizeCanvas();
                initializePositions();
                createBricks();
            }, 100);
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            resizeCanvas();
            initializePositions();
        });

        // Prevent scrolling on mobile
        document.body.addEventListener('touchstart', (e) => {
            if (e.target === canvas) {
                e.preventDefault();
            }
        }, { passive: false });

        document.body.addEventListener('touchend', (e) => {
            if (e.target === canvas) {
                e.preventDefault();
            }
        }, { passive: false });

        document.body.addEventListener('touchmove', (e) => {
            if (e.target === canvas) {
                e.preventDefault();
            }
        }, { passive: false });

        // Initialize audio context on first user interaction
        function initAudio() {
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        document.addEventListener('touchstart', initAudio, { once: true });
        document.addEventListener('click', initAudio, { once: true });
        document.addEventListener('keydown', initAudio, { once: true });

        // Initialize game
        createBricks();
        gameLoop();
    </script>
</body>
</html>